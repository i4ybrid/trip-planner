generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TripStatus {
  IDEA
  PLANNING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum MemberRole {
  MASTER
  ORGANIZER
  MEMBER
  VIEWER
}

enum MemberStatus {
  INVITED
  DECLINED
  MAYBE
  CONFIRMED
  REMOVED
}

enum InviteStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
  REVOKED
}

enum BookingStatus {
  PROPOSED
  CONFIRMED
  CANCELLED
  REFUNDED
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  SYSTEM
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  avatarUrl String?
  phone     String?
  venmo     String?
  paypal    String?
  zelle     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships         TripMember[]
  createdTrips        Trip[]               @relation("TripMaster")
  activities          Activity[]
  votes               Vote[]
  messages            TripMessage[]
  mediaItems          MediaItem[]
  notifications       Notification[]
  sentInvites         Invite[]             @relation("InviteSender")
  messageReactions    MessageReaction[]
  messageReadReceipts MessageReadReceipt[]
  pushSubscriptions   PushSubscription[]
}

model Trip {
  id           String     @id @default(cuid())
  name         String
  description  String?
  destination  String?
  startDate    DateTime?
  endDate      DateTime?
  coverImage   String?
  status       TripStatus @default(IDEA)
  tripMasterId String

  tripMaster    User           @relation("TripMaster", fields: [tripMasterId], references: [id])
  members       TripMember[]
  invites       Invite[]
  activities    Activity[]
  bookings      Booking[]
  messages      TripMessage[]
  mediaItems    MediaItem[]
  notifications Notification[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TripMember {
  id                 String       @id @default(cuid())
  tripId             String
  userId             String
  role               MemberRole   @default(MEMBER)
  status             MemberStatus @default(INVITED)
  paymentStatus      String?
  paymentAmount      Decimal?     @db.Decimal(10, 2)
  paymentConfirmedAt DateTime?
  joinedAt           DateTime     @default(now())

  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  @@unique([tripId, userId])
}

model Invite {
  id        String       @id @default(cuid())
  tripId    String
  token     String       @unique
  email     String?
  phone     String?
  status    InviteStatus @default(PENDING)
  expiresAt DateTime
  sentById  String

  trip     Trip            @relation(fields: [tripId], references: [id], onDelete: Cascade)
  sentBy   User            @relation("InviteSender", fields: [sentById], references: [id])
  channels InviteChannel[]

  createdAt DateTime @default(now())
}

model InviteChannel {
  id         String  @id @default(cuid())
  inviteId   String
  channel    String
  externalId String?

  invite Invite @relation(fields: [inviteId], references: [id], onDelete: Cascade)
}

model Activity {
  id           String    @id @default(cuid())
  tripId       String
  title        String
  description  String?
  location     String?
  startTime    DateTime?
  endTime      DateTime?
  cost         Decimal?  @db.Decimal(10, 2)
  currency     String    @default("USD")
  category     String
  proposedBy   String
  votingEndsAt DateTime?
  status       String    @default("OPEN")

  trip       Trip        @relation(fields: [tripId], references: [id], onDelete: Cascade)
  proposer   User        @relation(fields: [proposedBy], references: [id])
  votes      Vote[]
  bookings   Booking[]
  mediaItems MediaItem[]

  createdAt DateTime @default(now())
}

model Vote {
  id         String @id @default(cuid())
  activityId String
  userId     String
  option     String

  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id])

  @@unique([activityId, userId])
}

model Booking {
  id              String        @id @default(cuid())
  tripId          String
  activityId      String?
  bookedBy        String
  confirmationNum String?
  status          BookingStatus @default(PROPOSED)
  receiptUrl      String?
  notes           String?

  trip     Trip      @relation(fields: [tripId], references: [id], onDelete: Cascade)
  activity Activity? @relation(fields: [activityId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TripMessage {
  id          String      @id @default(cuid())
  tripId      String
  userId      String
  content     String
  messageType MessageType @default(TEXT)
  editedAt    DateTime?
  parentId    String?

  trip         Trip                 @relation(fields: [tripId], references: [id], onDelete: Cascade)
  user         User                 @relation(fields: [userId], references: [id])
  parent       TripMessage?         @relation("MessageEdits", fields: [parentId], references: [id])
  edits        TripMessage[]        @relation("MessageEdits")
  reactions    MessageReaction[]
  readReceipts MessageReadReceipt[]

  createdAt DateTime @default(now())
}

model MessageReaction {
  id        String @id @default(cuid())
  messageId String
  userId    String
  emoji     String

  message TripMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User        @relation(fields: [userId], references: [id])

  @@unique([messageId, userId, emoji])
}

model MessageReadReceipt {
  id        String   @id @default(cuid())
  messageId String
  userId    String
  readAt    DateTime @default(now())

  message TripMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User        @relation(fields: [userId], references: [id])

  @@unique([messageId, userId])
}

model MediaItem {
  id           String  @id @default(cuid())
  tripId       String
  uploaderId   String
  type         String
  url          String
  thumbnailUrl String?
  activityId   String?
  caption      String?

  trip     Trip      @relation(fields: [tripId], references: [id], onDelete: Cascade)
  uploader User      @relation(fields: [uploaderId], references: [id])
  activity Activity? @relation(fields: [activityId], references: [id])

  createdAt DateTime @default(now())
}

model Notification {
  id        String  @id @default(cuid())
  userId    String
  tripId    String?
  type      String
  title     String
  body      String
  actionUrl String?
  read      Boolean @default(false)

  user User  @relation(fields: [userId], references: [id])
  trip Trip? @relation(fields: [tripId], references: [id])

  createdAt DateTime @default(now())
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String
  p256dh    String
  auth      String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endpoint])
}
